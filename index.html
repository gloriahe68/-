<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="Furina.png">
    
    <title>æ³•è¯­æ•°å­—å¬å†™å¤§å¸ˆ Pro (0-1,000,000)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --error: #e74c3c; --success: #27ae60; --flashcard: #e67e22; --bg: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; color: #333; }
        
        .card { background: white; width: 100%; max-width: 550px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 30px; text-align: center; position: relative; min-height: 600px; display: flex; flex-direction: column; box-sizing: border-box; }
        
        #input-view, #quiz-view, #flash-view, #result-view, #mistake-view { 
            display: none; flex-direction: column; width: 100%; height: 100%;
        }

        .home-btn { position: absolute; top: 20px; right: 20px; background: #f0f0f0; border: none; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 13px; color: #666; transition: 0.2s; font-weight: 500; z-index: 10; }
        h2 { color: var(--primary); margin: 0 0 5px 0; font-weight: 700; }
        .mode-tag { font-size: 12px; color: #95a5a6; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }

        textarea { width: 100%; height: 160px; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; font-size: 16px; box-sizing: border-box; resize: none; margin-bottom: 5px; transition: 0.3s; background: #fafafa; }
        textarea:focus { border-color: var(--accent); background: #fff; outline: none; }
        
        .fr-keyboard { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 10px; border: 1px solid #eee; }
        .kb-btn { background: white; border: 1px solid #ddd; border-radius: 6px; width: 36px; height: 38px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; font-weight: 500; transition: 0.1s; }
        .kb-btn:active { background: var(--accent); color: white; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-full { grid-column: span 2; width: 100%; }
        .btn-dict { background: var(--accent); }
        .btn-flash { background: var(--flashcard); }
        .btn-mistakes { background: white; color: #7f8c8d; border: 2px solid #ecf0f1; grid-column: span 2; }
        .btn:active { transform: scale(0.98); }

        .quiz-input { width: 100%; padding: 14px; font-size: 22px; border: 2px solid var(--accent); border-radius: 10px; box-sizing: border-box; text-align: center; margin-top: 10px; outline: none; }
        .word-box { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold; color: var(--primary); margin: 10px 0; min-height: 120px; word-break: break-all; }
        .progress-bar { height: 6px; background: #eee; border-radius: 3px; margin: 10px auto 20px; width: 80%; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; }
        .audio-icon { font-size: 64px; cursor: pointer; color: var(--accent); margin: 15px 0; display: inline-block; }

        .result-list { text-align: left; margin-top: 10px; padding: 0; list-style: none; max-height: 350px; overflow-y: auto; border-top: 1px solid #eee; }
        .result-item { padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 15px; }
        .res-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .check-correct { color: var(--success); font-weight: bold; }
        .check-wrong { color: var(--error); font-weight: bold; }
        
        #mistake-container { margin: 20px 0; overflow-y: auto; max-height: 350px; border: 1px solid #f0f0f0; border-radius: 10px; }
        .mistake-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background: #fff; text-align: left; }
        .mistake-row:last-child { border-bottom: none; }
        .mistake-row:nth-child(even) { background: #fafafa; }
        .m-word { font-weight: 600; color: var(--primary); flex: 1; margin-right: 10px; word-break: break-all; }
        .m-actions { display: flex; gap: 8px; }
        .action-btn { border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-edit { background: #e0f2fe; color: #0284c7; }
        .btn-del { background: #fee2e2; color: #ef4444; }
    </style>
</head>
<body>

<div class="card">
    <button id="global-home-btn" class="home-btn" onclick="showView('input')" style="display:none">ğŸ  ä¸»é¡µ</button>

    <div id="input-view" style="display: flex;">
        <h2>ğŸ‡«ğŸ‡· æ³•è¯­å­¦ä¹ å¤§å¸ˆ</h2>
        <div class="mode-tag">Proç‰ˆ: æ”¯æŒ100ä¸‡ä»¥å†…æ•°å­—æ™ºèƒ½å¬å†™</div>
        <textarea id="raw-text" placeholder="10&#10;80&#10;200&#10;Bonjour&#10;..."></textarea>
        <div class="fr-keyboard" id="kb-home"></div>
        <div class="btn-group">
            <button class="btn btn-dict" onclick="startApp('dict', 'raw')">ğŸš€ å¬å†™æ¨¡å¼</button>
            <button class="btn btn-flash" onclick="startApp('flash', 'raw')">ğŸƒ é—ªå¡æ¨¡å¼</button>
            <button class="btn btn-mistakes" onclick="showMistakes()">é”™é¢˜æœ¬ (<span id="mistake-count">0</span>)</button>
        </div>
    </div>

    <div id="quiz-view">
        <div class="progress-bar"><div class="progress-fill" id="dict-progress"></div></div>
        <div class="audio-icon" onclick="playSound()">ğŸ”Š</div>
        <form onsubmit="event.preventDefault(); submitAnswer();" style="width: 100%; display: flex; flex-direction: column;">
            <div class="fr-keyboard" id="kb-quiz"></div>
            <input type="text" id="user-input" class="quiz-input" autocomplete="off" placeholder="å¬éŸ³å†™è¯ (æ•°å­—å†™æ³•è¯­)" spellcheck="false">
            <button type="submit" class="btn btn-full" style="background:var(--success); margin-top: 20px;">ç¡®è®¤æäº¤ (Enter)</button>
        </form>
    </div>

    <div id="flash-view">
        <div id="flash-counter" style="color:#95a5a6; font-size:14px">1 / 10</div>
        <div class="word-box" id="display-word" onclick="playSound()">Word</div>
        <div class="fr-keyboard" id="kb-flash"></div>
        <input type="text" id="flash-input" class="quiz-input" style="border-color:var(--flashcard)" autocomplete="off" placeholder="æ‰‹å†™ç»ƒä¹  (å¯é€‰)" spellcheck="false">
        <button class="btn btn-flash btn-full" onclick="submitFlash()" style="margin-top: 20px;">ä¸‹ä¸€ä¸ª (Enter/Space)</button>
    </div>

    <div id="result-view">
        <h3 id="result-title">ğŸ¯ ç»ƒä¹ æŠ¥å‘Š</h3>
        <div id="score-display" style="font-size: 16px; margin: 5px 0; color: #666;"></div>
        <ul class="result-list" id="final-list"></ul>
        <button class="btn btn-full" onclick="showView('input')" style="margin-top: 15px;">å®Œæˆå¹¶è¿”å›</button>
    </div>

    <div id="mistake-view">
        <h2>ğŸ“– é”™é¢˜æœ¬</h2>
        <div id="mistake-container"></div>
        <div class="btn-group">
            <button class="btn btn-dict" onclick="startApp('dict', 'mistakes')">å¬å†™é”™é¢˜</button>
            <button class="btn btn-flash" onclick="startApp('flash', 'mistakes')">é—ªå¡è¿‡é”™é¢˜</button>
            <button class="btn btn-full" style="background:#95a5a6" onclick="copyMistakes()">ğŸ“‹ å¤åˆ¶é”™é¢˜æ–‡æœ¬</button>
            <button class="btn btn-mistakes" onclick="showView('input')">è¿”å›ä¸»é¡µ</button>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒå˜é‡ ---
    let pool = [];
    let current = 0;
    let userAnswers = [];
    let mistakes = [];
    let activeMode = 'dict'; 
    const synth = window.speechSynthesis;
    const frChars = ['Ã©', 'Ã¨', 'Ãª', 'Ã«', 'Ã ', 'Ã¢', 'Ã®', 'Ã¯', 'Ã´', 'Ã»', 'Ã¹', 'Ã§', 'Å“'];

    // --- ğŸ”¢ å¼ºåŠ›ç‰ˆï¼šæ•°å­—è½¬æ³•è¯­ç®—æ³• (æ”¯æŒ 0 - 999,999) ---
    function numberToFrench(num) {
        let n = parseInt(num);
        if (isNaN(n)) return null;
        if (n < 0) return null;
        if (n === 0) return "zÃ©ro";

        const units = ["", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf"];
        const teens = ["dix", "onze", "douze", "treize", "quatorze", "quinze", "seize", "dix-sept", "dix-huit", "dix-neuf"];
        const tens = ["", "dix", "vingt", "trente", "quarante", "cinquante", "soixante", "soixante-dix", "quatre-vingt", "quatre-vingt-dix"];

        function convertSub100(val) {
            if (val < 10) return units[val];
            if (val < 20) return teens[val - 10];
            
            let ten = Math.floor(val / 10);
            let rem = val % 10;

            if (ten === 7 || ten === 9) {
                let base = (ten === 7) ? "soixante" : "quatre-vingt";
                let connector = (ten === 7 && rem === 1) ? " et " : "-";
                return base + connector + teens[rem];
            }

            let strTen = tens[ten];
            if (ten === 8) {
                if (rem === 0) return "quatre-vingts";
                return "quatre-vingt-" + units[rem];
            }

            if (rem === 0) return strTen;
            if (rem === 1) return strTen + " et un";
            return strTen + "-" + units[rem];
        }

        function convertSub1000(val) {
            if (val < 100) return convertSub100(val);
            let h = Math.floor(val / 100);
            let r = val % 100;
            let strH = (h === 1) ? "cent" : units[h] + " cent";
            if (h > 1 && r === 0) strH += "s";
            if (r === 0) return strH;
            return strH + " " + convertSub100(r);
        }

        // å¤„ç†ç™¾ä¸‡ä»¥å†… (999,999)
        if (n >= 1000000) return "è¶…å‡ºèŒƒå›´"; 

        let k = Math.floor(n / 1000);
        let r = n % 1000;
        let res = "";

        if (k > 0) {
            if (k === 1) {
                res = "mille";
            } else {
                let kStr = convertSub1000(k);
                // è¯­æ³•ä¿®æ­£ï¼šmilleå‰å»æ‰å¤æ•°s
                kStr = kStr.replace(/vingts$/, "vingt").replace(/cents$/, "cent");
                res = kStr + " mille";
            }
        }

        if (r > 0) {
            if (res !== "") res += " ";
            res += convertSub1000(r);
        } else if (k === 0) {
            res = convertSub1000(r);
        }

        return res.trim();
    }

    // --- è¾…åŠ©å‡½æ•° ---
    function getTargetWord(text) {
        const cleanText = text.replace(/\s/g, ''); 
        if (/^\d+$/.test(cleanText)) {
            const converted = numberToFrench(cleanText);
            if (converted) return converted;
        }
        return text;
    }

    function initKeyboards() {
        ['kb-home', 'kb-quiz', 'kb-flash'].forEach(id => {
            const kb = document.getElementById(id);
            if(!kb) return;
            frChars.forEach(char => {
                const btn = document.createElement('div');
                btn.className = 'kb-btn';
                btn.innerText = char;
                btn.onclick = (e) => {
                    e.preventDefault();
                    let targetId = id === 'kb-home' ? 'raw-text' : (id === 'kb-quiz' ? 'user-input' : 'flash-input');
                    const el = document.getElementById(targetId);
                    const start = el.selectionStart;
                    el.setRangeText(char, start, el.selectionEnd, 'end');
                    el.focus();
                };
                kb.appendChild(btn);
            });
        });
    }

    // --- App æµç¨‹ ---
    function startApp(mode, source) {
        let text = "";
        if (source === 'raw') {
            text = document.getElementById('raw-text').value.trim();
        } else {
            text = mistakes.join('\n');
        }

        if (!text) return alert("å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹");
        
        activeMode = mode;
        pool = text.split('\n').map(s => s.trim()).filter(s => s !== "");
        pool.sort(() => Math.random() - 0.5);
        
        current = 0;
        userAnswers = [];
        showView(mode === 'dict' ? 'quiz' : 'flash');
        mode === 'dict' ? renderQuiz() : renderFlash();
    }

    function renderQuiz() {
        if (current < pool.length) {
            document.getElementById('dict-progress').style.width = `${(current/pool.length)*100}%`;
            document.getElementById('user-input').value = "";
            document.getElementById('user-input').focus();
            setTimeout(playSound, 300);
        } else {
            showResults();
        }
    }

    function submitAnswer() {
        const val = document.getElementById('user-input').value.trim();
        userAnswers.push(val);
        
        const originalWord = pool[current];
        const targetWord = getTargetWord(originalWord); 

        // æ ¸å¿ƒå®¹é”™é€»è¾‘ï¼šå…¨éƒ¨è½¬å°å†™ï¼Œå…¨éƒ¨æ›¿æ¢è¿å­—ç¬¦å’Œå¤šä½™ç©ºæ ¼
        // "vingt-deux" -> "vingt deux"
        // "vingt deux" -> "vingt deux"
        // "Vingt  Deux" -> "vingt deux"
        const cleanVal = val.toLowerCase().replace(/-/g, ' ').replace(/\s+/g, ' ').trim(); 
        const cleanTarget = targetWord.toLowerCase().replace(/-/g, ' ').replace(/\s+/g, ' ').trim();

        let isCorrect = cleanVal === cleanTarget;

        if (!isCorrect) {
            if (!mistakes.includes(originalWord)) {
                mistakes.push(originalWord);
                saveData();
            }
        }
        current++;
        renderQuiz();
    }

    function renderFlash() {
        if (current < pool.length) {
            document.getElementById('display-word').innerText = pool[current];
            document.getElementById('flash-counter').innerText = `${current + 1} / ${pool.length}`;
            document.getElementById('flash-input').value = "";
            document.getElementById('flash-input').focus();
            const word = pool[current];
            if (!/[\u4e00-\u9fa5]/.test(word)) setTimeout(playSound, 300);
        } else {
            showResults();
        }
    }

    function submitFlash() {
        const val = document.getElementById('flash-input').value.trim();
        userAnswers.push(val);
        current++;
        renderFlash();
    }

    function showResults() {
        showView('result');
        const listEl = document.getElementById('final-list');
        const titleEl = document.getElementById('result-title');
        const scoreEl = document.getElementById('score-display');
        
        if (activeMode === 'dict') {
            titleEl.innerText = "ğŸ¯ å¬å†™æŠ¥å‘Š";
            let correct = 0;
            listEl.innerHTML = pool.map((word, i) => {
                const targetWord = getTargetWord(word); 
                
                const cleanVal = userAnswers[i].toLowerCase().replace(/-/g, ' ').replace(/\s+/g, ' ').trim(); 
                const cleanTarget = targetWord.toLowerCase().replace(/-/g, ' ').replace(/\s+/g, ' ').trim();
                const isCorrect = cleanVal === cleanTarget;

                if (isCorrect) correct++;
                
                const displayWord = (word !== targetWord) ? `${word} (${targetWord})` : word;

                return `<li class="result-item">
                    <div class="res-row"><b>${displayWord}</b> <span class="${isCorrect?'check-correct':'check-wrong'}">${isCorrect?'âœ”':'âœ˜'}</span></div>
                    ${!isCorrect ? `<div style="color:var(--error); font-size:13px">ä½ çš„æ‹¼å†™: ${userAnswers[i]||'(ç©º)'} <br>æ­£ç¡®æ‹¼å†™: <b>${targetWord}</b></div>` : ''}
                </li>`;
            }).join('');
            scoreEl.innerText = `å‡†ç¡®ç‡: ${Math.round((correct/pool.length)*100)}% (${correct}/${pool.length})`;
        } else {
            titleEl.innerText = "ğŸƒ é—ªå¡ç»ƒä¹ å›é¡¾";
            scoreEl.innerText = `æœ¬æ¬¡å…±æµè§ˆ ${pool.length} ä¸ªè¯æ¡`;
            listEl.innerHTML = pool.map((word, i) => {
                const targetWord = getTargetWord(word);
                const displayWord = (word !== targetWord) ? `${word} -> ${targetWord}` : word;
                return `<li class="result-item">
                    <div class="res-row"><b>${displayWord}</b></div>
                    <div style="color:#7f8c8d; font-size:13px">ç¬”è®°/è¾“å…¥: ${userAnswers[i] || '<span style="color:#ccc">æ— æ‰‹å†™è®°å½•</span>'}</div>
                </li>`;
            }).join('');
        }
    }

    function playSound() {
        synth.cancel();
        let word = pool[current];
        if(!word) return;

        let cleanWord = word.replace(/\s/g, '');
        if (/^\d+$/.test(cleanWord)) {
            const frNum = numberToFrench(cleanWord);
            if (frNum) word = frNum;
        }

        const utter = new SpeechSynthesisUtterance(word);
        utter.lang = /[\u4e00-\u9fa5]/.test(word) ? 'zh-CN' : 'fr-FR';
        utter.rate = 0.85; 
        synth.speak(utter);
    }

    function showView(view) {
        const views = ['input-view', 'quiz-view', 'flash-view', 'result-view', 'mistake-view'];
        views.forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        const target = document.getElementById(view + '-view');
        target.style.display = 'flex';
        target.style.flexDirection = 'column';
        document.getElementById('global-home-btn').style.display = view === 'input' ? 'none' : 'block';
    }

    function saveData() { 
        localStorage.setItem('fr_mistakes_v4', JSON.stringify(mistakes)); 
        document.getElementById('mistake-count').innerText = mistakes.length;
    }
    
    function loadData() {
        mistakes = JSON.parse(localStorage.getItem('fr_mistakes_v4') || '[]');
        document.getElementById('mistake-count').innerText = mistakes.length;
    }

    function showMistakes() {
        showView('mistake');
        const container = document.getElementById('mistake-container');
        if (!mistakes.length) {
            container.innerHTML = "<div style='color:#ccc; padding:40px;'>æš‚æ— é”™é¢˜ï¼Œç»§ç»­åŠ æ²¹ï¼</div>";
            return;
        }
        
        container.innerHTML = mistakes.map((m, idx) => `
            <div class="mistake-row">
                <span class="m-word">${m}</span>
                <div class="m-actions">
                    <button class="action-btn btn-edit" onclick="editMistake(${idx})">âœ</button>
                    <button class="action-btn btn-del" onclick="deleteMistake(${idx})">ğŸ—‘</button>
                </div>
            </div>
        `).join('');
    }

    function deleteMistake(index) {
        if(confirm(`ç¡®å®šåˆ é™¤ "${mistakes[index]}" å—ï¼Ÿ`)) {
            mistakes.splice(index, 1);
            saveData();
            showMistakes();
        }
    }

    function editMistake(index) {
        const oldVal = mistakes[index];
        const newVal = prompt("ä¿®æ”¹å•è¯å†…å®¹:", oldVal);
        if (newVal !== null && newVal.trim() !== "") {
            mistakes[index] = newVal.trim();
            saveData();
            showMistakes();
        }
    }

    function copyMistakes() {
        if(!mistakes.length) return alert("æ²¡æœ‰é”™é¢˜å¯å¤åˆ¶");
        navigator.clipboard.writeText(mistakes.join('\n')).then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
    }

    document.addEventListener('keydown', (e) => {
        const isQuiz = document.getElementById('quiz-view').style.display === 'flex';
        const isFlash = document.getElementById('flash-view').style.display === 'flex';
        
        if (isQuiz && e.code === 'Space' && e.ctrlKey) { 
            e.preventDefault(); 
            playSound(); 
        }
        
        if (isFlash && e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            submitFlash(); 
        }
    });

    loadData();
    initKeyboards();
</script>
</body>
</html>
